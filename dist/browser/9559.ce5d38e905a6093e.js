"use strict";(self.webpackChunkdspace_angular=self.webpackChunkdspace_angular||[]).push([[9559,5665],{49559:(X,g,o)=>{o.d(g,{w:()=>O});var E=o(54460),t=o(53107),c=o(10936),I=o(69685),j=o(83649),R=o.n(j),y=o(71217),A=o(88249),b=o(33325),W=o(76627),F=o(37610),$=o(47947),C=o(27035),S=o(82040),U=o(21706),L=o(83116),T=(o(47587),o(12007)),B=o(96858),u=o(72683),x=o(79224),M=o(15614),G=(o(6548),o(75665)),K=o(2155);function V(e,p){if(1&e&&t.nrm(0,"ds-type-badge",17),2&e){const s=t.XpG(3);t.Y8G("object",s.dso)}}function D(e,p){if(1&e&&(t.j41(0,"span",15),t.DNE(1,V,1,1,"ds-type-badge",16),t.k0s()),2&e){const s=t.XpG(2);t.R7$(),t.Y8G("ngIf",!!s.dso)}}function J(e,p){if(1&e&&(t.j41(0,"div",24),t.nrm(1,"input",25),t.j41(2,"label",26),t.EFF(3),t.nI1(4,"translate"),t.k0s()()),2&e){const s=p.$implicit;t.R7$(),t.Y8G("id","checkbox-"+s)("formControlName",s),t.R7$(),t.Y8G("for","checkbox-"+s),t.R7$(),t.JRh(t.bMT(4,4,"subscriptions.modal.new-subscription-form.frequency."+s))}}function _(e,p){1&e&&(t.j41(0,"ds-alert",27),t.EFF(1),t.nI1(2,"translate"),t.k0s()),2&e&&(t.Y8G("type","alert-danger"),t.R7$(),t.SpI(" ",t.bMT(2,2,"context-menu.actions.subscription.frequency.required")," "))}function l(e,p){if(1&e&&(t.j41(0,"fieldset",18)(1,"legend",19),t.EFF(2),t.nI1(3,"translate"),t.k0s(),t.j41(4,"div",20),t.nrm(5,"input",21),t.DNE(6,J,5,6,"div",22),t.k0s(),t.DNE(7,_,3,4,"ds-alert",23),t.k0s()),2&e){const s=p.$implicit,i=t.XpG(2);t.FS9("formGroupName",s.key),t.R7$(2),t.SpI(" ",t.bMT(3,5,"subscriptions.modal.new-subscription-form.type."+s.key),": "),t.R7$(3),t.Y8G("value",null==s||null==s.value?null:s.value.controls.subscriptionId.value),t.R7$(),t.Y8G("ngForOf",i.frequencyDefaultValues),t.R7$(),t.Y8G("ngIf",!!i.submitted&&(null==s||null==s.value||null==s.value.controls.frequencies.errors?null:s.value.controls.frequencies.errors.required))}}function d(e,p){1&e&&(t.j41(0,"p",28),t.EFF(1),t.nI1(2,"translate"),t.k0s()),2&e&&(t.R7$(),t.JRh(t.bMT(2,1,"subscriptions.modal.delete-info")))}function r(e,p){1&e&&(t.j41(0,"span"),t.nrm(1,"i",29),t.EFF(2),t.nI1(3,"translate"),t.k0s()),2&e&&(t.R7$(2),t.SpI(" ",t.bMT(3,1,"subscriptions.modal.new-subscription-form.processing")," "))}function P(e,p){1&e&&(t.j41(0,"span"),t.EFF(1),t.nI1(2,"translate"),t.k0s()),2&e&&(t.R7$(),t.SpI(" ",t.bMT(2,1,"subscriptions.modal.new-subscription-form.submit")," "))}function N(e,p){if(1&e){const s=t.RV6();t.j41(0,"form",1),t.bIt("ngSubmit",function(){t.eBV(s);const n=t.XpG();return t.Njj(n.submit())}),t.j41(1,"div",2)(2,"h4",3),t.EFF(3),t.nI1(4,"translate"),t.k0s(),t.j41(5,"button",4),t.bIt("click",function(){t.eBV(s);const n=t.XpG();return t.Njj(n.activeModal.close())}),t.j41(6,"span",5),t.EFF(7,"\xd7"),t.k0s()()(),t.j41(8,"div",6)(9,"p",7)(10,"strong"),t.EFF(11),t.k0s(),t.DNE(12,D,2,1,"span",8),t.k0s(),t.j41(13,"div"),t.DNE(14,l,8,7,"fieldset",9),t.nI1(15,"keyvalue"),t.k0s(),t.DNE(16,d,3,3,"p",10),t.nI1(17,"async"),t.k0s(),t.j41(18,"div",11)(19,"button",12),t.bIt("click",function(){t.eBV(s);const n=t.XpG();return t.Njj(n.activeModal.close())}),t.EFF(20),t.nI1(21,"translate"),t.k0s(),t.j41(22,"button",13),t.nI1(23,"async"),t.DNE(24,r,4,3,"span",14),t.nI1(25,"async"),t.DNE(26,P,3,3,"span",14),t.nI1(27,"async"),t.k0s()()()}if(2&e){const s=t.XpG();t.Y8G("formGroup",s.subscriptionForm),t.R7$(3),t.JRh(t.bMT(4,10,"subscriptions.modal.title")),t.R7$(8),t.JRh(s.dsoNameService.getName(s.dso)),t.R7$(),t.Y8G("ngIf",!!s.dso),t.R7$(2),t.Y8G("ngForOf",t.bMT(15,12,null==s.subscriptionForm?null:s.subscriptionForm.controls)),t.R7$(2),t.Y8G("ngIf",t.bMT(17,14,s.showDeleteInfo$)),t.R7$(4),t.SpI(" ",t.bMT(21,16,"subscriptions.modal.close")," "),t.R7$(2),t.Y8G("disabled",t.bMT(23,18,s.processing$)||!s.isValid),t.R7$(2),t.Y8G("ngIf",t.bMT(25,20,s.processing$)),t.R7$(2),t.Y8G("ngIf",!0!==t.bMT(27,22,s.processing$))}}let O=(()=>{class e{constructor(s,i,n,f,a,m,v,H){this.formBuilder=s,this.modalService=i,this.notificationsService=n,this.subscriptionService=f,this.activeModal=a,this.authService=m,this.translate=v,this.dsoNameService=H,this.processing$=new y.t(!1),this.showDeleteInfo$=new y.t(!1),this.submitted=!1,this.subscriptionDefaultTypes=["content"],this.frequencyDefaultValues=["D","W","M"],this.isValid=!1,this.updateSubscription=new t.bkB}ngOnInit(){this.authService.getAuthenticatedUserFromStore().pipe((0,F.s)(1),(0,$.T)(s=>s.uuid),(0,A.t)({refCount:!1})).subscribe(s=>{this.ePersonId=s,(0,u.hj)(this.subscription)?this.initFormByGivenSubscription():this.initFormByAllSubscriptions()}),this.subscriptionForm.valueChanges.subscribe(s=>{let i=!1;for(const n of this.frequencyDefaultValues)i=i||s.content.frequencies[n];this.isValid=i})}initFormByAllSubscriptions(){this.subscriptionForm=new c.J3({});for(const s of this.subscriptionDefaultTypes){const i=new c.J3({});i.addControl("subscriptionId",this.formBuilder.control("")),i.addControl("frequencies",this.formBuilder.group({}));for(const n of this.frequencyDefaultValues)i.controls.frequencies.addControl(n,this.formBuilder.control(!1));this.subscriptionForm.addControl(s,i)}this.initFormDataBySubscriptions()}initFormByGivenSubscription(){const s=new c.J3({});s.addControl("subscriptionId",this.formBuilder.control(this.subscription.id)),s.addControl("frequencies",this.formBuilder.group({})),s.get("frequencies").addValidators(c.k0.required);for(const i of this.frequencyDefaultValues){const n=-1!==R()(this.subscription.subscriptionParameterList,["value",i]);s.controls.frequencies.addControl(i,this.formBuilder.control(n))}this.subscriptionForm=this.formBuilder.group({[this.subscription.subscriptionType]:s})}initFormDataBySubscriptions(){this.processing$.next(!0),this.subscriptionService.getSubscriptionsByPersonDSO(this.ePersonId,this.dso?.uuid).pipe((0,T.ak)()).subscribe({next:s=>{if(s.pageInfo.totalElements>0){this.showDeleteInfo$.next(!0);for(const i of s.page){const f=this.subscriptionForm.get(i.subscriptionType);if((0,u.hj)(f)){f.controls.subscriptionId.setValue(i.id);for(const a of i.subscriptionParameterList.filter(m=>"frequency"===m.name))f.controls.frequencies.controls[a.value]?.setValue(!0)}}}this.processing$.next(!1)},error:s=>{this.processing$.next(!1)}})}submit(){this.submitted=!0;const s=Object.keys(this.subscriptionForm.controls),i=[],n=[];s.forEach(a=>{const m=this.subscriptionForm.controls[a];if(m.touched&&m.dirty){const v=this.createBody(m.controls.subscriptionId.value,a,m.controls.frequencies);(0,u.hj)(v.id)?n.push(v):(0,u.hj)(v.subscriptionParameterList)&&i.push(v)}});const f=[];(0,u.hj)(i)&&f.push((0,b.H)(i).pipe((0,C.Z)(a=>this.subscriptionService.createSubscription(a,this.ePersonId,this.dso.uuid).pipe((0,T.qD)())),(0,S.M)(a=>{if(a.hasSucceeded){const m=this.translate.instant("subscriptions.modal.create.success",{type:a.payload.subscriptionType});this.notificationsService.success(null,m)}else this.notificationsService.error(null,this.translate.instant("subscriptions.modal.create.error"))}))),(0,u.hj)(n)&&f.push((0,b.H)(n).pipe((0,C.Z)(a=>this.subscriptionService.updateSubscription(a,this.ePersonId,this.dso.uuid).pipe((0,T.qD)())),(0,S.M)(a=>{if(a.hasSucceeded){const m=this.translate.instant("subscriptions.modal.update.success",{type:a.payload.subscriptionType});this.notificationsService.success(null,m),(0,u.hj)(this.subscription)&&this.updateSubscription.emit(a.payload)}else this.notificationsService.error(null,this.translate.instant("subscriptions.modal.update.error"))}))),(0,W.z)([...f]).subscribe(a=>{this.activeModal.close()})}createBody(s,i,n){const f={id:(0,u.hj)(s)?s:null,subscriptionType:i,subscriptionParameterList:[]};for(const a of this.frequencyDefaultValues)n.value[a]&&f.subscriptionParameterList.push({name:"frequency",value:a});return f}static#t=this.\u0275fac=function(i){return new(i||e)(t.rXU(c.ze),t.rXU(K.Bq),t.rXU(x.I),t.rXU(G.SubscriptionsDataService),t.rXU(K.Lw),t.rXU(U.uR),t.rXU(I.c$),t.rXU(L.f))};static#s=this.\u0275cmp=t.VBU({type:e,selectors:[["ds-subscription-modal"]],inputs:{dso:"dso",subscription:"subscription"},outputs:{updateSubscription:"updateSubscription"},standalone:!0,features:[t.aNF],decls:1,vars:1,consts:[["data-test","subscription-form",3,"formGroup","ngSubmit",4,"ngIf"],["data-test","subscription-form",3,"ngSubmit","formGroup"],[1,"modal-header"],[1,"modal-title"],["type","button","aria-label","Close",1,"close",3,"click"],["aria-hidden","true"],[1,"modal-body"],[1,"mb-3"],["class","float-right",4,"ngIf"],["class","form-group form-row",3,"formGroupName",4,"ngFor","ngForOf"],["class","text-muted",4,"ngIf"],[1,"modal-footer"],["type","button",1,"btn","btn-outline-secondary",3,"click"],["type","submit",1,"btn","btn-success",3,"disabled"],[4,"ngIf"],[1,"float-right"],[3,"object",4,"ngIf"],[3,"object"],[1,"form-group","form-row",3,"formGroupName"],[1,"col-md-4","col-form-label","float-md-left","pt-0"],[1,"col-md-8"],["type","hidden","formControlName","subscriptionId",3,"value"],["class","form-check","formGroupName","frequencies",4,"ngFor","ngForOf"],[3,"type",4,"ngIf"],["formGroupName","frequencies",1,"form-check"],["type","checkbox",1,"form-check-input",3,"id","formControlName"],[1,"form-check-label",3,"for"],[3,"type"],[1,"text-muted"],[1,"fas","fa-circle-notch","fa-spin"]],template:function(i,n){1&i&&t.DNE(0,N,28,24,"form",0),2&i&&t.Y8G("ngIf",n.subscriptionForm)},dependencies:[E.bT,c.YN,c.qT,c.me,c.Zm,c.BC,c.cb,c.X1,c.j4,c.JD,c.$R,M.C,E.pM,B.C,E.Jj,E.lG,I.h,I.D9]})}return e})()},75665:(X,g,o)=>{o.r(g),o.d(g,{SubscriptionsDataService:()=>V});var E=o(37610),t=o(47947),c=o(22867),I=o(41483),j=o(66645),R=o(86856),y=o(83116),A=o(45122),b=o(99120),W=o(25718),F=o(83951),$=o(2887),C=o(12350),S=o(24632),U=o(36705),L=o(70210),Y=o(9843),T=o(25744),B=o(12007),u=o(72683),x=o(79224),M=o(24106),h=o(53107),G=o(27691),K=o(73958);let V=(()=>{class D extends $.W{constructor(_,l,d,r,P,N,O,e,p){super("subscriptions",r,P,O,e),this.comparator=_,this.http=l,this.notificationsService=d,this.requestService=r,this.rdbService=P,this.store=N,this.objectCache=O,this.halService=e,this.nameService=p,this.findByEpersonLinkPath="findByEPerson",this.searchData=new C.X(this.linkPath,r,P,O,e,this.responseMsToLive),this.deleteData=new F.I(this.linkPath,r,P,O,e,d,this.responseMsToLive,this.constructIdEndpoint)}getSubscriptionsByPersonDSO(_,l){const d=Object.assign(new U._,{searchParams:[new b.x("resource",l),new b.x("eperson_id",_)]});return this.searchData.searchBy("findByEPersonAndDso",d,!1,!0)}createSubscription(_,l,d){return this.halService.getEndpoint(this.linkPath).pipe((0,u.VT)(),(0,E.s)(1),(0,t.T)(r=>`${r}?resource=${d}&eperson_id=${l}`),(0,t.T)(r=>new L.QU(this.requestService.generateRequestId(),r,JSON.stringify(_))),(0,R.w$)(this.requestService),(0,c.n)(r=>this.rdbService.buildFromRequestUUID(r.uuid)),(0,B.qD)())}updateSubscription(_,l,d){return this.halService.getEndpoint(this.linkPath).pipe((0,u.VT)(),(0,E.s)(1),(0,t.T)(r=>`${r}/${_.id}?resource=${d}&eperson_id=${l}`),(0,t.T)(r=>new L.v_(this.requestService.generateRequestId(),r,JSON.stringify(_))),(0,R.w$)(this.requestService),(0,c.n)(r=>this.rdbService.buildFromRequestUUID(r.uuid)),(0,B.qD)())}deleteSubscription(_){return this.halService.getEndpoint(this.linkPath).pipe((0,I.p)(l=>(0,u.hj)(l)),(0,j.F)(),(0,c.n)(l=>this.deleteData.delete(_)),(0,B.qD)())}findAllSubscriptions(_){return this.findAllData.findAll(_,!0,!0,(0,M.s)("resource"),(0,M.s)("eperson"))}findByEPerson(_,l){const d=Object.assign(new U._,l,{searchParams:[new b.x("uuid",_)]});return this.getEndpoint().pipe((0,t.T)(r=>`${r}/search/${this.findByEpersonLinkPath}`),(0,c.n)(r=>this.findListByHref(r,d,!1,!0,(0,M.s)("resource"),(0,M.s)("eperson"))))}static#t=this.\u0275fac=function(l){return new(l||D)(h.KVO(S.j),h.KVO(G.Qq),h.KVO(x.I),h.KVO(Y.B),h.KVO(A.o),h.KVO(K.il),h.KVO(W.$),h.KVO(T.Y),h.KVO(y.f))};static#s=this.\u0275prov=h.jDH({token:D,factory:D.\u0275fac,providedIn:"root"})}return D})()}}]);